(()=>{"use strict";var e={d:(s,t)=>{for(var i in t)e.o(t,i)&&!e.o(s,i)&&Object.defineProperty(s,i,{enumerable:!0,get:t[i]})},o:(e,s)=>Object.prototype.hasOwnProperty.call(e,s)};e.d({},{y:()=>b,p:()=>R});class s{constructor(e){this.element=document.createElement(e.tag),this.createElement(e)}createElement(e){e.classNames.forEach((e=>{var s;return null===(s=this.element)||void 0===s?void 0:s.classList.add(e)})),e.text&&(this.element.textContent=e.text)}getElement(){return this.element}appendElement(e){var s;null===(s=this.element)||void 0===s||s.append(e)}removeElement(){this.element.remove()}}const t=new class extends s{constructor(){super({tag:"div",classNames:["modalBackground"]}),this.modal=new s({tag:"div",classNames:["modal"]}).getElement(),this.title=new s({tag:"h3",classNames:["modal__title"]}).getElement(),this.btnClose=new s({tag:"button",classNames:["btn","btn-action","btn-close"],text:"Ok"}).getElement(),this.prepareModal()}prepareModal(){this.btnClose.addEventListener("click",(()=>this.hideModal())),this.modal.append(this.title,this.btnClose),this.getElement().append(this.modal)}setTitle(e){this.title.textContent=e}showModal(e){this.setTitle(e),this.getElement().classList.add("show")}hideModal(){this.getElement().classList.remove("show")}addModalToDOM(){document.body.append(this.getElement())}},i=new class{saveUserToLS(e,s=""){const t={login:e.login,password:s,isLogined:e.isLogined};sessionStorage.setItem("LH_user",JSON.stringify(t))}getActiveUser(){const e=sessionStorage.getItem("LH_user");return e?JSON.parse(e):null}removeUser(){sessionStorage.removeItem("LH_user")}};var a,r,n,o;!function(e){e[e.login=0]="login",e[e.main=1]="main"}(a||(a={})),function(e){e[e.login=0]="login",e[e.main=1]="main"}(r||(r={})),function(e){e.login="USER_LOGIN",e.logout="USER_LOGOUT",e.usersActive="USER_ACTIVE",e.usersNonActive="USER_INACTIVE",e.msgSend="MSG_SEND",e.msgHistory="MSG_FROM_USER",e.msgRead="MSG_READ",e.error="ERROR",e.externalLogin="USER_EXTERNAL_LOGIN",e.externalLogout="USER_EXTERNAL_LOGOUT",e.msgDelete="MSG_DELETE",e.msgEdit="MSG_EDIT",e.msgDelivery="MSG_DELIVER"}(n||(n={})),function(e){e.active="active",e.nonactive="nonactive"}(o||(o={}));const l=[{path:"login",view:a.login},{path:"main",view:a.main}],d=new class{constructor(e){this.config=l,this.pathSegmentsToKeep=e,this.addListenerToWindow()}start(){const e=i.getActiveUser();if(e)return c.sendRequestForUserLogin(e.login,e.password),R.setCurrentUser(e.login,e.password),void this.main();this.goToPath(this.config[r.login])}main(){R.getActiveUser()&&(this.goToPath(this.config[r.main]),R.setActiveUser(),b.mainPage.setActiveUser(),b.clearLoginForm())}goToPath(e){const s=window.location.pathname.split("/").slice(1,this.pathSegmentsToKeep+1).join("/");try{history.pushState({},"",`/${s}/${e.path}`)}catch(s){history.pushState({},"",`/${e.path}`)}b.render(e.view)}getShortPath(e){return e.split("/").at(-1)||""}goTo(e){const s=this.config.find((s=>s.path===e));s&&b.render(s.view)}addListenerToWindow(){window.addEventListener("popstate",(()=>{const e=this.getShortPath(window.location.pathname);this.goTo(`${e}`)})),window.addEventListener("beforeunload",(()=>{c.closeConnection()}))}}(0);class h{getRequestForLogin(e,s,t){return{id:String(e),type:n.login,payload:{user:{login:s,password:t}}}}getRequestForLogout(e,s){return{id:String(e),type:n.logout,payload:{user:{login:s.login,password:s.password}}}}getRequestForOnlineUsers(e){return{id:String(e),type:n.usersActive,payload:null}}getRequestForOfflineUsers(e){return{id:String(e),type:n.usersNonActive,payload:null}}getRequestForMessageToUser(e,s,t){return{id:String(e),type:n.msgSend,payload:{message:{to:s,text:t}}}}getRequestForHistoryMessageFromUser(e,s){return{id:String(e),type:n.msgHistory,payload:{user:{login:s}}}}getRequestForStatusRead(e,s){return{id:String(e),type:n.msgRead,payload:{message:{id:s}}}}getRequestForMessageDelete(e,s){return{id:String(e),type:n.msgDelete,payload:{message:{id:s}}}}getRequestForMessageEdit(e,s,t){return{id:String(e),type:n.msgEdit,payload:{message:{id:s,text:t}}}}}const g="ws://localhost:4000",c=new class{constructor(){this.id=1,this.socket=new WebSocket(g),this.requests=[],this.message=new h,this.addListeners()}openConnection(){this.socket=new WebSocket(g),this.addListeners();const e=R.getActiveUser();e&&(R.logout(),R.setCurrentUser(e.login,e.password),this.sendRequestForUserLogin(e.login,e.password))}addListeners(){this.socket.onopen=()=>t.hideModal(),this.socket.onclose=()=>{t.showModal("No connection with server!"),this.openConnection()},this.socket.onmessage=e=>{this.readMessage(e)},this.socket.onerror=e=>{this.readError(e)}}readError(e){this.checkServerStatus()&&console.log(e)}readMessage(e){const s=JSON.parse(e.data);if(null===s.id)return void this.readMessageFromServer(s);const t=this.requests.find((e=>e.id===s.id));t&&(s.type!==n.error?(t.type===n.login&&this.readMessageLogin(s),t.type===n.usersActive&&this.readMessageAllUsers(s,o.active),t.type===n.usersNonActive&&this.readMessageAllUsers(s,o.nonactive),t.type===n.msgHistory&&this.readMessageHistory(s,t.user),t.type===n.msgSend&&this.readMessageFromUser(s),t.type===n.msgDelete&&this.readMessageDeleteMessage(s),t.type===n.msgEdit&&this.readMessageEditMessage(s)):this.readErrorMessage(s))}readMessageEditMessage(e){R.editMessageInChat(e)}readMessageDeleteMessage(e){R.deleteMessage(e)}readMessageFromUser(e){R.showNewMessage(e)}readMessageHistory(e,s){R.showUnreadMessages(e,s),R.showDialogHistory(e,s)}readMessageFromServer(e){e.type!==n.externalLogin&&e.type!==n.externalLogout?e.type!==n.msgSend?e.type!==n.msgDelete?e.type!==n.msgEdit?e.type!==n.msgDelivery?e.type!==n.msgRead||this.readMessageReadMessageFromServer(e):this.readMessageDeliveryMessageFromServer(e):this.readMessageEditMessageFromServer(e):this.readMessageDeleteMessageFromServer(e):this.readMessageNewMessageFromServer(e):this.readMessageLoginLogoutFromServer(e)}readMessageReadMessageFromServer(e){R.changeStatusToRead(e)}readMessageDeliveryMessageFromServer(e){R.changeStatusToDelivery(e)}readMessageEditMessageFromServer(e){R.editMessageInChat(e)}readMessageDeleteMessageFromServer(e){R.deleteMessage(e)}readMessageLoginLogoutFromServer(e){R.updateStatusUser(e.payload.user)}readMessageNewMessageFromServer(e){R.showNewMessage(e)}readErrorMessage(e){t.showModal(e.payload.error)}readMessageLogin(e){var s;i.saveUserToLS(e.payload.user,null===(s=R.getActiveUser())||void 0===s?void 0:s.password),R.setActiveUser(),this.sendRequestsForAllUsers(),d.main()}readMessageAllUsers(e,s){const t=e.payload.users;b.mainPage.updateUsers(t,s)}sendMessage(e){this.waitForSendMessage((()=>this.socket.send(JSON.stringify(e)))),this.requests.push({id:e.id,type:e.type,user:this.getUserFromMsg(e)}),this.id+=1}getUserFromMsg(e){return e.payload&&"user"in e.payload?e.payload.user.login:""}checkServerStatus(){return 0===this.socket.readyState&&this.waitForConnect((()=>t.showModal("Connecting to server!"))),1===this.socket.readyState||3===this.socket.readyState&&this.waitForConnect((()=>t.showModal("No connection with server!"))),!0}waitForConnect(e){setTimeout((()=>{1===this.socket.readyState?t.hideModal():this.waitForConnect(e)}),5)}waitForSendMessage(e){setTimeout((()=>{1===this.socket.readyState?(t.hideModal(),e()):this.waitForSendMessage(e)}),5)}sendRequestForUserLogin(e,s){if(this.checkServerStatus()){const t=this.message.getRequestForLogin(this.id,e,s);this.sendMessage(t)}}sendRequestForUserLogout(e){if(this.checkServerStatus()){const s=this.message.getRequestForLogout(this.id,e);this.sendMessage(s)}}sendRequestForOnlineUsers(){if(this.checkServerStatus()){const e=this.message.getRequestForOnlineUsers(this.id);this.sendMessage(e)}}sendRequestForOfflineUsers(){if(this.checkServerStatus()){const e=this.message.getRequestForOfflineUsers(this.id);this.sendMessage(e)}}sendRequestsForAllUsers(){this.sendRequestForOnlineUsers(),this.sendRequestForOfflineUsers()}sendRequestForMessage(e,s){if(this.checkServerStatus()){const t=this.message.getRequestForMessageToUser(this.id,e,s);this.sendMessage(t)}}sendRequestForUnreadMessage(e){if(this.checkServerStatus()){const s=this.message.getRequestForHistoryMessageFromUser(this.id,e);this.sendMessage(s)}}sentRequestForStatusRead(e){if(this.checkServerStatus()){const s=this.message.getRequestForStatusRead(this.id,e);this.sendMessage(s)}}closeConnection(){this.socket.close()}sendRequestForMessageDelete(e){if(this.checkServerStatus()){const s=this.message.getRequestForMessageDelete(this.id,e);this.sendMessage(s)}}sendRequestForMessageEdit(e,s){if(this.checkServerStatus()){const t=this.message.getRequestForMessageEdit(this.id,e,s);this.sendMessage(t)}}};function u(e,s,t){const i=e.value.trim();if(!1===s.test(i)){e.classList.remove("form__login__item-valid"),e.classList.add("form__login__item-notvalid");const s=e.nextElementSibling;return s&&(s.textContent=t),!1}return e.classList.add("form__login__item-valid"),!0}function m(e){return!(!function(e,s){if(!e.value.trim().length){e.classList.remove("form__login__item-valid"),e.classList.add("form__login__item-notvalid");const s=e.nextElementSibling;return s&&(s.textContent="The field is required!"),!1}return e.classList.add("form__login__item-valid"),!0}(e)||"text"===e.type&&!u(e,/^[a-zA-Z-]+$/,"Only English letters and the hyphen ara allowed")||!u(e,/.{4}/,"The field should contain minimal 4 characters")||"password"===e.type&&!u(e,/[a-zA-Z]+/,"The passwors should contain minimal one English letters"))}class p extends s{constructor(){super({tag:"form",classNames:["login__form"]}),this.user=this.createFormInputElement(["login__form__input"],"login_login","text"),this.password=this.createFormInputElement(["login__form__input","login__form__input-password"],"login_password","password"),this.btnLogin=this.createFormSubmitElement(),this.prepareForm()}createFormSubmitElement(){const e=new s({tag:"button",classNames:["btn","btn-action","btn-login"],text:"Login"}).getElement();return e.addEventListener("click",(e=>this.login(e))),e}createFormInputElement(e,t,i){const a=new s({tag:"input",classNames:e}).getElement();return a.id=t,a.required=!0,a.type=i,a.addEventListener("focusin",(()=>function(e){e.classList.remove("form__login__item-notvalid");const s=e.nextElementSibling;s&&(s.textContent="")}(a))),a.addEventListener("focusout",(()=>function(e){m(e)}(a))),a}prepareForm(){const e=this.createFormItem("Login",this.user,"login_login"),s=this.createFormItem("Password",this.password,"login_password");this.getElement().append(e,s,this.btnLogin)}createFormItem(e,s,t){const i=this.createFormItemWrapper(),a=this.createFormLabel(e,t),r=this.createFormMessage();return i.append(a,s,r),i}createFormItemWrapper(){return new s({tag:"div",classNames:["login__form__item"]}).getElement()}createFormLabel(e,t){const i=new s({tag:"label",classNames:["login__form__item__label"],text:e}).getElement();return i.setAttribute("for",t),i}createFormMessage(){return new s({tag:"span",classNames:["login__form__item__message"]}).getElement()}login(e){e.preventDefault(),function(e){for(let s=0;s<e.length;s+=1)if(!m(e[s]))return!1;return!0}([this.user,this.password])&&(R.setCurrentUser(this.user.value.trim(),this.password.value.trim()),c.sendRequestForUserLogin(this.user.value.trim(),this.password.value.trim()))}clearForm(){this.user.value="",this.password.value="",this.user.classList.remove("form__login__item-valid"),this.password.classList.remove("form__login__item-valid")}}class v{constructor(){this.container=new s({tag:"div",classNames:["container","container__login"]}).getElement(),this.loginForm=new p,this.createPage()}createPage(){this.container.append(this.loginForm.getElement())}getPage(){return this.container}clearLoginForm(){this.loginForm.clearForm()}}const M='<svg class="statusMessage__ico" width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M2 12L7.25 17C7.25 17 8.66939 15.3778 9.875 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M8 12L13.25 17L22 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M16 7L12.5 11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>',w='<svg class="actionMessage__ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M15.6287 5.12132L4.31497 16.435M15.6287 5.12132L19.1642 8.65685M15.6287 5.12132L17.0429 3.70711C17.4334 3.31658 18.0666 3.31658 18.4571 3.70711L20.5784 5.82843C20.969 6.21895 20.969 6.85212 20.5784 7.24264L19.1642 8.65685M7.85051 19.9706L4.31497 16.435M7.85051 19.9706L19.1642 8.65685M7.85051 19.9706L3.25431 21.0312L4.31497 16.435" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';class f extends s{constructor(){super({tag:"footer",classNames:["footer"]}),this.rsschool=this.createFooterItem("https://rs.school/",'<svg class="footer__ico" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 552.8 205.3" width="100px"><style>.st0{fill:#fff}.st1{clip-path:url(#SVGID_2_)}.st2{clip-path:url(#SVGID_4_)}.st3{clip-path:url(#SVGID_6_)}.st4{clip-path:url(#SVGID_8_)}.st5{fill:#fff;stroke-width:4;stroke-miterlimit:10}.st6{clip-path:url(#SVGID_8_)}.st6,.st7{fill:none;stroke:#000;stroke-width:4;stroke-miterlimit:10}.st8,.st9{clip-path:url(#SVGID_10_)}.st9{fill:none;stroke:#000;stroke-width:4;stroke-miterlimit:10}</style><title>rs_school_js</title><path d="M285.4 68l26.3-1.7c.6 4.3 1.7 7.5 3.5 9.8 2.9 3.6 6.9 5.4 12.2 5.4 3.9 0 7-.9 9.1-2.8 2-1.5 3.2-3.9 3.2-6.4 0-2.4-1.1-4.7-3-6.2-2-1.8-6.7-3.6-14.1-5.2-12.1-2.7-20.8-6.3-25.9-10.9-5.1-4.3-8-10.6-7.8-17.3 0-4.6 1.4-9.2 4-13 3-4.3 7.1-7.7 12-9.6 5.3-2.3 12.7-3.5 22-3.5 11.4 0 20.1 2.1 26.1 6.4 6 4.2 9.6 11 10.7 20.3l-26 1.5c-.7-4-2.1-6.9-4.4-8.8s-5.3-2.8-9.2-2.8c-3.2 0-5.6.7-7.2 2-1.5 1.2-2.5 3-2.4 5 0 1.5.8 2.9 2 3.8 1.3 1.2 4.4 2.3 9.3 3.3 12.1 2.6 20.7 5.2 26 7.9 5.3 2.7 9.1 6 11.4 9.9 2.4 4 3.6 8.6 3.5 13.3 0 5.6-1.6 11.2-4.8 15.9-3.3 4.9-7.9 8.7-13.3 11-5.7 2.5-12.9 3.8-21.5 3.8-15.2 0-25.7-2.9-31.6-8.8S286.1 77 285.4 68zM6.3 97.6V8.2h46.1c8.5 0 15.1.7 19.6 2.2 4.4 1.4 8.3 4.3 10.9 8.2 2.9 4.3 4.3 9.3 4.2 14.5.3 8.8-4.2 17.2-11.9 21.6-3 1.7-6.3 2.9-9.7 3.5 2.5.7 5 1.9 7.2 3.3 1.7 1.4 3.1 3 4.4 4.7 1.5 1.7 2.8 3.6 3.9 5.6l13.4 25.9H63L48.2 70.2c-1.9-3.5-3.5-5.8-5-6.9-2-1.4-4.4-2.1-6.8-2.1H34v36.3H6.3zM34 44.4h11.7c2.5-.2 4.9-.6 7.3-1.2 1.8-.3 3.4-1.3 4.5-2.8 2.7-3.6 2.3-8.7-1-11.8-1.8-1.5-5.3-2.3-10.3-2.3H34v18.1zM0 174.2l26.3-1.7c.6 4.3 1.7 7.5 3.5 9.8 2.8 3.6 6.9 5.5 12.2 5.5 3.9 0 7-.9 9.1-2.8 2-1.6 3.2-3.9 3.2-6.4 0-2.4-1.1-4.7-3-6.2-2-1.8-6.7-3.6-14.2-5.2-12.1-2.7-20.8-6.3-25.9-10.9-5.1-4.3-8-10.6-7.8-17.3 0-4.6 1.4-9.2 4-13 3-4.3 7.1-7.7 12-9.6 5.3-2.3 12.7-3.5 22-3.5 11.4 0 20.1 2.1 26.1 6.4s9.5 11 10.6 20.3l-26 1.5c-.7-4-2.1-6.9-4.4-8.8-2.2-1.9-5.3-2.8-9.2-2.7-3.2 0-5.6.7-7.2 2.1-1.6 1.2-2.5 3-2.4 5 0 1.5.8 2.9 2 3.8 1.3 1.2 4.4 2.3 9.3 3.3 12.1 2.6 20.7 5.2 26 7.9 5.3 2.7 9.1 6 11.4 9.9 2.4 4 3.6 8.6 3.6 13.2 0 5.6-1.7 11.1-4.8 15.8-3.3 4.9-7.9 8.7-13.3 11-5.7 2.5-12.9 3.8-21.5 3.8-15.2 0-25.7-2.9-31.6-8.8-5.9-6-9.2-13.4-10-22.4z"/><path d="M133 167.2l24.2 7.3c-1.3 6.1-4 11.9-7.7 17-3.4 4.5-7.9 8-13 10.3-5.2 2.3-11.8 3.5-19.8 3.5-9.7 0-17.7-1.4-23.8-4.2-6.2-2.8-11.5-7.8-16-14.9-4.5-7.1-6.7-16.2-6.7-27.3 0-14.8 3.9-26.2 11.8-34.1s19-11.9 33.4-11.9c11.3 0 20.1 2.3 26.6 6.8 6.4 4.6 11.2 11.6 14.4 21l-24.4 5.4c-.6-2.1-1.5-4.2-2.7-6-1.5-2.1-3.4-3.7-5.7-4.9-2.3-1.2-4.9-1.7-7.5-1.7-6.3 0-11.1 2.5-14.4 7.6-2.5 3.7-3.8 9.6-3.8 17.6 0 9.9 1.5 16.7 4.5 20.4 3 3.7 7.2 5.5 12.7 5.5 5.3 0 9.3-1.5 12-4.4 2.7-3.1 4.7-7.4 5.9-13zm56.5-52.8h27.6v31.3h30.2v-31.3h27.8v89.4h-27.8v-36.2h-30.2v36.2h-27.6v-89.4z"/><path d="M271.3 159.1c0-14.6 4.1-26 12.2-34.1 8.1-8.1 19.5-12.2 34-12.2 14.9 0 26.3 4 34.4 12S364 144 364 158.4c0 10.5-1.8 19-5.3 25.7-3.4 6.6-8.7 12-15.2 15.6-6.7 3.7-15 5.6-24.9 5.6-10.1 0-18.4-1.6-25-4.8-6.8-3.4-12.4-8.7-16.1-15.2-4.1-7-6.2-15.7-6.2-26.2zm27.6.1c0 9 1.7 15.5 5 19.5 3.3 3.9 7.9 5.9 13.7 5.9 5.9 0 10.5-1.9 13.8-5.8s4.9-10.8 4.9-20.8c0-8.4-1.7-14.6-5.1-18.4-3.4-3.9-8-5.8-13.8-5.8-5.1-.2-10 2-13.4 5.9-3.4 3.9-5.1 10.4-5.1 19.5zm93.4-.1c0-14.6 4.1-26 12.2-34.1 8.1-8.1 19.5-12.2 34-12.2 14.9 0 26.4 4 34.4 12S485 144 485 158.4c0 10.5-1.8 19-5.3 25.7-3.4 6.6-8.7 12-15.2 15.6-6.7 3.7-15 5.6-24.9 5.6-10.1 0-18.4-1.6-25-4.8-6.8-3.4-12.4-8.7-16.1-15.2-4.1-7-6.2-15.7-6.2-26.2zm27.6.1c0 9 1.7 15.5 5 19.5 3.3 3.9 7.9 5.9 13.7 5.9 5.9 0 10.5-1.9 13.8-5.8 3.3-3.9 4.9-10.8 4.9-20.8 0-8.4-1.7-14.6-5.1-18.4-3.4-3.9-8-5.8-13.8-5.8-5.1-.2-10.1 2-13.4 5.9-3.4 3.9-5.1 10.4-5.1 19.5z"/><path d="M482.1 114.4h27.6v67.4h43.1v22H482v-89.4z"/><ellipse transform="rotate(-37.001 420.46 67.88)" class="st0" cx="420.5" cy="67.9" rx="63" ry="51.8"/><defs><ellipse id="SVGID_1_" transform="rotate(-37.001 420.46 67.88)" cx="420.5" cy="67.9" rx="63" ry="51.8"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" overflow="visible"/></clipPath><g class="st1"><path transform="rotate(-37.001 420.82 68.353)" class="st0" d="M330.9-14.2h179.8v165.1H330.9z"/><g id="Layer_2_1_"><defs><path id="SVGID_3_" transform="rotate(-37.001 420.82 68.353)" d="M330.9-14.2h179.8v165.1H330.9z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" overflow="visible"/></clipPath><g id="Layer_1-2" class="st2"><ellipse transform="rotate(-37.001 420.46 67.88)" class="st0" cx="420.5" cy="67.9" rx="63" ry="51.8"/><defs><ellipse id="SVGID_5_" transform="rotate(-37.001 420.46 67.88)" cx="420.5" cy="67.9" rx="63" ry="51.8"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" overflow="visible"/></clipPath><g class="st3"><path transform="rotate(-37 420.799 68.802)" class="st0" d="M357.8 17h125.9v103.7H357.8z"/><defs><path id="SVGID_7_" transform="rotate(-37 420.799 68.802)" d="M357.8 17h125.9v103.7H357.8z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" overflow="visible"/></clipPath><g class="st4"><ellipse transform="rotate(-37.001 420.46 67.88)" class="st5" cx="420.5" cy="67.9" rx="63" ry="51.8"/></g><path transform="rotate(-37 420.799 68.802)" class="st6" d="M357.8 17h125.9v103.7H357.8z"/><ellipse transform="rotate(-37.001 420.46 67.88)" class="st7" cx="420.5" cy="67.9" rx="63" ry="51.8"/><path transform="rotate(-37 420.799 68.802)" class="st0" d="M357.8 17h125.9v103.7H357.8z"/><defs><path id="SVGID_9_" transform="rotate(-37 420.799 68.802)" d="M357.8 17h125.9v103.7H357.8z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" overflow="visible"/></clipPath><g class="st8"><ellipse transform="rotate(-37.001 420.46 67.88)" class="st5" cx="420.5" cy="67.9" rx="63" ry="51.8"/></g><path transform="rotate(-37 420.799 68.802)" class="st9" d="M357.8 17h125.9v103.7H357.8z"/><path transform="rotate(-37.001 420.82 68.353)" class="st7" d="M330.9-14.2h179.8v165.1H330.9z"/></g><ellipse transform="rotate(-37.001 420.46 67.88)" class="st7" cx="420.5" cy="67.9" rx="63" ry="51.8"/><path d="M392.4 61.3l10-7 12.3 17.5c2.1 2.8 3.7 5.8 4.9 9.1.7 2.5.5 5.2-.5 7.6-1.3 3-3.4 5.5-6.2 7.3-3.3 2.3-6.1 3.6-8.5 4-2.3.4-4.7 0-6.9-1-2.4-1.2-4.5-2.9-6.1-5.1l8.6-8c.7 1.1 1.6 2.1 2.6 2.9.7.5 1.5.8 2.4.8.7 0 1.4-.3 1.9-.7 1-.6 1.7-1.8 1.6-3-.3-1.7-1-3.4-2.1-4.7l-14-19.7zm30 11.1l9.1-7.2c1 1.2 2.3 2.1 3.7 2.6 2 .6 4.1.2 5.8-1.1 1.2-.8 2.2-1.9 2.6-3.3.6-1.8-.4-3.8-2.2-4.4-.3-.1-.6-.2-.9-.2-1.2-.1-3.3.4-6.4 1.7-5.1 2.1-9.1 2.9-12.1 2.6-2.9-.3-5.6-1.8-7.2-4.3-1.2-1.7-1.8-3.7-1.9-5.7 0-2.3.6-4.6 1.9-6.5 1.9-2.7 4.2-5 7-6.8 4.2-2.9 7.9-4.3 11.1-4.3 3.2 0 6.2 1.5 9 4.6l-9 7.1c-1.8-2.3-5.2-2.8-7.5-1l-.3.3c-1 .6-1.7 1.5-2.1 2.6-.3.8-.1 1.7.4 2.4.4.5 1 .9 1.7.9.8.1 2.2-.3 4.2-1.2 5-2.1 8.8-3.3 11.4-3.7 2.2-.4 4.5-.2 6.6.7 1.9.8 3.5 2.2 4.6 3.9 1.4 2 2.2 4.4 2.3 6.9.1 2.6-.6 5.1-2 7.3-1.8 2.7-4.1 5-6.8 6.8-5.5 3.8-10 5.4-13.6 4.8-3.9-.6-7.1-2.6-9.4-5.5z"/></g></g></g></svg>'),this.github=this.createFooterItem("https://github.com/Zarembochka",'<svg class="footer__ico" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 64 64" width="55px" height="55px"><path d="M32 6C17.641 6 6 17.641 6 32c0 12.277 8.512 22.56 19.955 25.286-.592-.141-1.179-.299-1.755-.479V50.85c0 0-.975.325-2.275.325-3.637 0-5.148-3.245-5.525-4.875-.229-.993-.827-1.934-1.469-2.509-.767-.684-1.126-.686-1.131-.92-.01-.491.658-.471.975-.471 1.625 0 2.857 1.729 3.429 2.623 1.417 2.207 2.938 2.577 3.721 2.577.975 0 1.817-.146 2.397-.426.268-1.888 1.108-3.57 2.478-4.774-6.097-1.219-10.4-4.716-10.4-10.4 0-2.928 1.175-5.619 3.133-7.792C19.333 23.641 19 22.494 19 20.625c0-1.235.086-2.751.65-4.225 0 0 3.708.026 7.205 3.338C28.469 19.268 30.196 19 32 19s3.531.268 5.145.738c3.497-3.312 7.205-3.338 7.205-3.338.567 1.474.65 2.99.65 4.225 0 2.015-.268 3.19-.432 3.697C46.466 26.475 47.6 29.124 47.6 32c0 5.684-4.303 9.181-10.4 10.4 1.628 1.43 2.6 3.513 2.6 5.85v8.557c-.576.181-1.162.338-1.755.479C49.488 54.56 58 44.277 58 32 58 17.641 46.359 6 32 6zM33.813 57.93C33.214 57.972 32.61 58 32 58 32.61 58 33.213 57.971 33.813 57.93zM37.786 57.346c-1.164.265-2.357.451-3.575.554C35.429 57.797 36.622 57.61 37.786 57.346zM32 58c-.61 0-1.214-.028-1.813-.07C30.787 57.971 31.39 58 32 58zM29.788 57.9c-1.217-.103-2.411-.289-3.574-.554C27.378 57.61 28.571 57.797 29.788 57.9z"/></svg>'),this.year=this.createYear(),this.prepareFooter()}prepareFooter(){this.getElement().append(this.rsschool,this.year,this.github)}createFooterItem(e,t){const i=new s({tag:"a",classNames:["footer__item"]}).getElement();return i.href=e,i.setAttribute("target","_blank"),i.innerHTML=t,i}createYear(){return new s({tag:"span",classNames:["footer__item"],text:"2024"}).getElement()}}class _ extends s{constructor(){super({tag:"header",classNames:["header"]}),this.title=this.createTitle(),this.btnLogout=this.createBtnLogout(),this.prepareHeader()}prepareHeader(){this.getElement().append(this.title,this.btnLogout)}createTitle(){return new s({tag:"h1",classNames:["header__title"],text:"Fun-chat"}).getElement()}createBtnLogout(){const e=new s({tag:"button",classNames:["btn","btn-action","btn-logout"],text:"Logout"}).getElement();return e.addEventListener("click",(()=>this.logout())),e}setUserName(){this.title.textContent=`Fun-chat: ${this.getUsername()}`}logout(){i.removeUser(),d.start(),R.logout()}getUsername(){var e;return(null===(e=R.getActiveUser())||void 0===e?void 0:e.login)||""}}class E extends s{constructor(){super({tag:"aside",classNames:["users"]}),this.search=this.createInputElement(),this.userList=this.createUsersList(),this.user=null,this.onlineUsers=[],this.offlineUsers=[],this.prepareUsers()}prepareUsers(){this.search.addEventListener("keyup",(()=>this.findUsers())),this.getElement().append(this.search,this.userList),window.addEventListener("new-message",(e=>this.showNewMessageIco(e))),window.addEventListener("unread-messages",(e=>this.showUnreadMessagesIco(e))),window.addEventListener("user-change-status",(e=>this.updateStatus(e))),window.addEventListener("user-change",(e=>this.updateUser(e))),window.addEventListener("logout",(()=>this.clearUsers()))}updateUser(e){if(e instanceof CustomEvent){const s=e.detail.user;this.user=s}}createInputElement(){const e=new s({tag:"input",classNames:["users__search"]}).getElement();return e.type="text",e.placeholder="...Search",e}createUsersList(){return new s({tag:"ul",classNames:["users__list"]}).getElement()}createUsersItem(e,t){const i=new s({tag:"li",classNames:["users__list__item",t]}).getElement(),a=new s({tag:"span",classNames:["users__list__item__status"]}).getElement();a.innerHTML='<svg class="status__ico" width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M2 9.1371C2 14 6.01943 16.5914 8.96173 18.9109C10 19.7294 11 20.5 12 20.5C13 20.5 14 19.7294 15.0383 18.9109C17.9806 16.5914 22 14 22 9.1371C22 4.27416 16.4998 0.825464 12 5.50063C7.50016 0.825464 2 4.27416 2 9.1371Z"></path> </g></svg>';const r=new s({tag:"span",classNames:["users__list__item__login"],text:e}).getElement(),n=new s({tag:"span",classNames:["users__list__item__ico"]}).getElement();return i.append(a,r,n),i.addEventListener("click",(()=>this.selectUser(e,t))),i}selectUser(e,s){this.showUserInfo(e,s),c.sendRequestForUnreadMessage(e)}showUserInfo(e,s){R.selectUser({login:e,isLogined:"active"===s})}updateUsers(e,s,t){this.removeOldUsers(s),e.forEach((e=>{if(e.login!==(null==t?void 0:t.login)){const t=this.createUsersItem(e.login,s);this.userList.append(t),c.sendRequestForUnreadMessage(e.login),s===o.active?this.onlineUsers.push(e):this.offlineUsers.push(e)}}))}updateUserList(e,s,t){this.removeOldUsers(s),e.forEach((e=>{if(e.login!==(null==t?void 0:t.login)){const t=this.createUsersItem(e.login,s);this.userList.append(t),c.sendRequestForUnreadMessage(e.login)}}))}removeOldUsers(e){[...document.querySelectorAll(`.users__list__item.${e}`)].forEach((e=>e.remove()))}clearUsers(){for(this.user=null,this.onlineUsers.length=0,this.offlineUsers.length=0;this.userList.firstChild;)this.userList.firstChild.remove()}findUsers(){const e=this.search.value;this.hideOtherUsers(e)}hideOtherUsers(e){const s=[...document.querySelectorAll(".users__list__item__login")];s.forEach((e=>{var s;return null===(s=e.parentElement)||void 0===s?void 0:s.classList.add("hide")})),s.filter((s=>{var t;return null===(t=s.textContent)||void 0===t?void 0:t.includes(e)})).forEach((e=>{var s;return null===(s=e.parentElement)||void 0===s?void 0:s.classList.remove("hide")}))}showNewMessageIco(e){if(e instanceof CustomEvent){const s=e.detail.from,t=this.findUser(s),i=this.msgsCount(t);t&&t.nextElementSibling&&(t.nextElementSibling.textContent=String(i+1),t.nextElementSibling.classList.add("show"))}}msgsCount(e){let s=0;return e&&e.nextElementSibling&&e.nextElementSibling.textContent&&(s=parseInt(e.nextElementSibling.textContent)),s}findUser(e){return[...document.querySelectorAll(".users__list__item__login")].find((s=>s.textContent===e))}showUnreadMessagesIco(e){if(e instanceof CustomEvent){const s=e.detail.from,t=this.findUser(s),i=e.detail.count;if(t&&t.nextElementSibling){if(t.nextElementSibling.textContent=String(i),i>0)return void t.nextElementSibling.classList.add("show");t.nextElementSibling.classList.remove("show")}}}updateStatus(e){if(e instanceof CustomEvent){const s=e.detail.user.login;this.changeStatusForUser(s)||(e.detail.user.isLogined?this.onlineUsers.push(e.detail.user):this.offlineUsers.push(e.detail.user)),this.showNewUsers()}}showNewUsers(){this.onlineUsers.sort(((e,s)=>e.login.localeCompare(s.login))),this.offlineUsers.sort(((e,s)=>e.login.localeCompare(s.login))),this.updateUserList(this.onlineUsers,o.active,R.getActiveUser()),this.updateUserList(this.offlineUsers,o.nonactive,R.getActiveUser())}changeStatusForUser(e){const s=this.findActiveUser(e);if(s)return this.removeUserFromActive(s),!0;{const s=this.findInactiveUser(e);if(s)return this.removeUserFromInactive(s),!0}return!1}findActiveUser(e){return this.onlineUsers.find((s=>s.login===e))}removeUserFromActive(e){const s=this.onlineUsers.filter((s=>s.login!==e.login));this.onlineUsers=[...s],this.offlineUsers.push(e)}findInactiveUser(e){return this.offlineUsers.find((s=>s.login===e))}removeUserFromInactive(e){const s=this.offlineUsers.filter((s=>s.login!==e.login));this.offlineUsers=[...s],this.onlineUsers.push(e)}}class S extends s{constructor(e,s,t,i,a){super({tag:"div",classNames:["message"]}),this.id=e,this.header=this.createHTMLElement("message__header",s),this.body=this.createHTMLElement("message__body"),this.content=this.createHTMLElement("message__body__content",i),this.btnDelete=this.createBtnElement("btn-delete",'<svg class="actionMessage__ico" width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M5 7.5H19L18 21H6L5 7.5Z" stroke-linejoin="round"></path> <path d="M15.5 9.5L15 19" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 9.5V19" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M8.5 9.5L9 19" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M16 5H19C20.1046 5 21 5.89543 21 7V7.5H3V7C3 5.89543 3.89543 5 5 5H8M16 5L15 3H9L8 5M16 5H8" stroke-linejoin="round"></path> </g></svg>',"delete"),this.btnEdit=this.createBtnElement("btn-edit",w,"edit"),this.footer=this.createHTMLElement("message__footer"),this.time=this.createHTMLElement("message__footer__time",this.getDate(t)),this.status=this.createHTMLElement("message__footer__status"),this.statusEdited=this.createHTMLElement("message__footer__statusEdited"),this.status.innerHTML=M,this.prepareMessage(a)}prepareMessage(e){this.setStatusesForMessage(e),this.btnDelete.addEventListener("click",(()=>this.deleteMessage())),this.btnEdit.addEventListener("click",(()=>this.editMessage())),this.body.append(this.btnDelete,this.btnEdit,this.content),this.footer.append(this.time,this.statusEdited,this.status),this.getElement().append(this.header,this.body,this.footer)}setStatusesForMessage(e){e.isEdited&&this.changeStatusToEdited(),e.isDelivered&&this.setStatusDelivered(),e.isReaded&&this.setStatusRead()}setStatusDelivered(){this.status.innerHTML='<svg class="statusMessage__ico" width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M2 12L7.25 17C7.25 17 8.66939 15.3778 9.875 14" stroke="#0bbf2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M8 12L13.25 17L22 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M16 7L12.5 11" stroke="#0bbf2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>'}setStatusRead(){this.status.innerHTML=M,this.status.classList.add("readed")}getDate(e){const s=new Date(e),t=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getHours()).padStart(2,"0"),a=String(s.getMinutes()).padStart(2,"0");return`${s.getDate()}/${t}/${s.getFullYear()}  ${i}.${a}`}createHTMLElement(e,t){return new s({tag:"div",classNames:[e],text:t}).getElement()}createBtnElement(e,t,i){const a=new s({tag:"button",classNames:["btn","btn-message",e]}).getElement();return a.innerHTML=t,a.title=`${i} message`,a}deleteMessage(){c.sendRequestForMessageDelete(this.id)}editMessage(){this.content.textContent&&R.editMessage(this.id,this.content.textContent)}editTextMessage(e){this.content.textContent=e,this.changeStatusToEdited()}changeStatusToEdited(){this.statusEdited.innerHTML=w}}class L extends s{constructor(){super({tag:"main",classNames:["chat__dialog"]}),this.user=null,this.startMessage=new s({tag:"div",classNames:["chat__startDialog"],text:"Select user to start chat!"}).getElement(),this.separateLine=new s({tag:"div",classNames:["chat__separateLine"],text:"Unread messages"}).getElement(),this.unreadMessages=[],this.allMessages=[],this.prepareMain()}prepareMain(){this.showStartMessage(),window.addEventListener("user-change",(e=>this.updateUser(e))),window.addEventListener("history-dialog",(e=>this.showDialog(e))),window.addEventListener("new-message",(e=>this.showNewMessage(e))),window.addEventListener("logout",(()=>this.logout())),window.addEventListener("delete-message",(e=>this.removeMessageFromChat(e))),window.addEventListener("edited-message",(e=>this.editedMessageInChat(e))),window.addEventListener("change-status",(e=>this.changeStatus(e))),this.startListenToReadMessagesClick()}startListenToReadMessages(){this.startListenToReadMessagesClick()}startListenToReadMessagesScroll(){this.getElement().addEventListener("scroll",this.readAllMessages.bind(this),!1)}startListenToReadMessagesClick(){this.getElement().addEventListener("click",this.readAllMessages.bind(this),!1)}readAllMessages(){this.removeSeparateLine(),this.user&&R.allMessagesRead(this.user.login),this.changeStatusForRead(),this.stopListenToReadMessages()}stopListenToReadMessages(){this.getElement().removeEventListener("scroll",this.readAllMessages,!1),this.getElement().removeEventListener("click",this.readAllMessages,!1)}removeSeparateLine(){this.separateLine.remove()}updateUser(e){if(this.removeOldMessades(),e instanceof CustomEvent){const s=e.detail.user;this.user=s,this.startMessage.textContent="Send your first message!",this.showStartMessage(),this.allMessages=[],this.unreadMessages=[]}}showDialog(e){if(this.user&&e instanceof CustomEvent&&this.user.login===e.detail.user){this.removeOldMessades();const s=e.detail.messages.messages;s.length&&this.showHistoryMessage(s)}}showStartMessage(){this.getElement().append(this.startMessage)}showHistoryMessage(e){const s=e.filter((e=>{var s;return e.status.isReaded||e.from===(null===(s=R.getActiveUser())||void 0===s?void 0:s.login)})),t=e.filter((e=>{var s;return!e.status.isReaded&&e.from!==(null===(s=R.getActiveUser())||void 0===s?void 0:s.login)}));this.showDialogWithUser(s),t.length&&(this.appendElement(this.separateLine),this.showDialogWithUser(t),this.scrollToUnreadMessages(),this.startListenToReadMessages())}showDialogWithUser(e){e.forEach((e=>{var s,t;const i=new S(e.id,e.from,e.datetime,e.text,e.status);this.allMessages.push(i);const a=i.getElement();e.from===(null===(s=R.getActiveUser())||void 0===s?void 0:s.login)&&a.classList.add("author"),this.appendElement(a),e.status.isReaded||e.to!==(null===(t=R.getActiveUser())||void 0===t?void 0:t.login)||this.unreadMessages.push(e)}))}removeOldMessades(){for(var e;this.getElement().firstElementChild;)null===(e=this.getElement().firstElementChild)||void 0===e||e.remove()}logout(){this.user=null,this.removeOldMessades(),this.showStartMessage()}scrollToLastMessage(e){this.isUnreadMessages()?this.scrollToUnreadMessages():e.scrollIntoView({block:"end",inline:"nearest",behavior:"smooth"})}scrollToUnreadMessages(){this.separateLine.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}showNewMessage(e){var s,t,i;if(this.user&&e instanceof CustomEvent&&(this.user.login===e.detail.from||e.detail.from===(null===(s=R.getActiveUser())||void 0===s?void 0:s.login))){this.removeStartMessage();const s=new S(e.detail.id,e.detail.from,e.detail.datetime,e.detail.text,e.detail.status);this.allMessages.push(s);const a=s.getElement();e.detail.from===(null===(t=R.getActiveUser())||void 0===t?void 0:t.login)&&(a.classList.add("author"),this.readAllMessages()),this.isUnreadMessages()||e.detail.from===(null===(i=R.getActiveUser())||void 0===i?void 0:i.login)||this.appendElement(this.separateLine),e.detail.status.isReaded||this.user.login!==e.detail.from||this.unreadMessages.push(e.detail),this.appendElement(a),this.scrollToLastMessage(a)}}removeStartMessage(){this.startMessage.remove()}changeStatusForRead(){this.unreadMessages.forEach((e=>c.sentRequestForStatusRead(e.id))),this.unreadMessages.length=0}isUnreadMessages(){return!!this.getElement().querySelector(".chat__separateLine")}removeMessageFromChat(e){if(e instanceof CustomEvent){const s=e.detail.id;this.removeMessage(s)}}removeMessage(e){const s=this.findMesssage(e);s&&(s.removeElement(),this.removeMessageFromAll(e),this.removeMessageFromUnread(e),this.checkChatLength())}findMesssage(e){return this.allMessages.find((s=>s.id===e))}removeMessageFromAll(e){const s=this.allMessages.filter((s=>s.id!==e));this.allMessages=[...s]}removeMessageFromUnread(e){const s=this.unreadMessages.filter((s=>s.id!==e));this.unreadMessages=[...s],this.unreadMessages.length||this.removeSeparateLine()}checkChatLength(){this.getElement().childElementCount||this.showStartMessage()}editedMessageInChat(e){if(e instanceof CustomEvent){const s=e.detail.id,t=e.detail.text;this.editMessage(s,t)}}editMessage(e,s){const t=this.findMesssage(e);t&&t.editTextMessage(s)}changeStatus(e){if(e instanceof CustomEvent){const s=e.detail.id,t=e.detail.status;this.changeStatusForMessage(s,t)}}changeStatusForMessage(e,s){const t=this.findMesssage(e);t&&t.setStatusesForMessage(s)}}class U extends s{constructor(){super({tag:"form",classNames:["message__form"]}),this.message=this.createFormInputElement(["message__form__input"]),this.btnSend=this.createFormSubmitElement(),this.user="",this.idEditMessage=null,this.prepareForm()}createFormSubmitElement(){const e=new s({tag:"button",classNames:["btn","btn-action","btn-send"],text:"Send"}).getElement();return e.disabled=!0,e.addEventListener("click",(e=>this.sendMessage(e))),e}createFormInputElement(e){const t=new s({tag:"input",classNames:e}).getElement();return t.placeholder="...Message",t.required=!0,t.disabled=!0,t.addEventListener("keyup",(()=>this.checkMessageLength())),t}prepareForm(){this.getElement().append(this.message,this.btnSend),window.addEventListener("user-change",(e=>this.enableForm(e))),window.addEventListener("edit-message",(e=>this.editMessage(e)))}enableForm(e){e instanceof CustomEvent&&(this.user=e.detail.user.login,this.message.disabled=!1)}checkMessageLength(){this.message.value.trim()?this.btnSend.disabled=!1:this.btnSend.disabled=!0}sendMessage(e){e.preventDefault(),R.getActiveUser()&&(this.idEditMessage?c.sendRequestForMessageEdit(this.idEditMessage,this.message.value.trim()):c.sendRequestForMessage(this.user,this.message.value.trim()),this.clearForm())}clearForm(){this.message.value="",this.idEditMessage=null}editMessage(e){e instanceof CustomEvent&&(this.idEditMessage=e.detail.id,this.message.value=e.detail.text,this.message.disabled=!1,this.btnSend.disabled=!1)}}class y extends s{constructor(){super({tag:"footer",classNames:["chat__footer"]}),this.messageForm=new U,this.prepareFooter()}prepareFooter(){this.getElement().append(this.messageForm.getElement())}}class F extends s{constructor(){super({tag:"header",classNames:["chat__header"]}),this.userName=new s({tag:"div",classNames:["chat__header__userName"]}).getElement(),this.userStatus=new s({tag:"div",classNames:["chat__header__userStatus"]}).getElement(),this.user=null,this.prepareHeader()}prepareHeader(){this.getElement().append(this.userName,this.userStatus),window.addEventListener("user-change",(e=>this.updateInfo(e))),window.addEventListener("user-change-status",(e=>this.updateStatus(e))),window.addEventListener("logout",(()=>this.logout()))}updateInfo(e){if(e instanceof CustomEvent){const s=e.detail.user;this.user=s,this.userName.textContent=s.login,this.changeUserStatus(s.isLogined)}}changeUserStatus(e){this.userStatus.textContent=e?"online":"offline",this.userStatus.classList.remove("online"),this.userStatus.classList.remove("offline"),this.userStatus.classList.add(e?"online":"offline")}updateStatus(e){var s;if(e instanceof CustomEvent){const t=e.detail.user;(null===(s=this.user)||void 0===s?void 0:s.login)===t.login&&this.changeUserStatus(t.isLogined)}}logout(){this.user=null,this.userName.textContent="",this.userStatus.textContent=""}}class x extends s{constructor(){super({tag:"article",classNames:["chat"]}),this.header=new F,this.dialog=new L,this.footer=new y,this.prepareChat()}prepareChat(){this.getElement().append(this.header.getElement(),this.dialog.getElement(),this.footer.getElement())}}class C extends s{constructor(){super({tag:"main",classNames:["main"]}),this.users=new E,this.chat=new x,this.prepareMainPart()}prepareMainPart(){this.getElement().append(this.users.getElement(),this.chat.getElement())}updateUsers(e,s){this.users.updateUsers(e,s,R.getActiveUser())}removeUsers(){this.users.clearUsers()}}class k{constructor(){this.container=new s({tag:"div",classNames:["container","container__main"]}).getElement(),this.header=new _,this.main=new C,this.footer=new f,this.createPage()}createPage(){this.container.append(this.header.getElement(),this.main.getElement(),this.footer.getElement())}getPage(){return this.container}setActiveUser(){this.header.setUserName()}updateUsers(e,s){this.main.updateUsers(e,s)}removeUsers(){this.main.removeUsers()}}!function(e){if("/"===e.search[1]){const s=e.search.slice(1).split("&").map((function(e){return e.replace(/~and~/g,"&")})).join("?"),t=e.pathname.slice(0,-1)+s+e.hash;window.history.replaceState(null,"",t)}}(window.location);const b=new class{constructor(){this.loginPage=new v,this.mainPage=new k}renderPage(e){document.body.innerHTML="",document.body.append(e.getPage(),t.getElement())}render(e){e!==a.login?this.renderPage(this.mainPage):this.renderPage(this.loginPage)}clearLoginForm(){this.loginPage.clearLoginForm()}},R=new class{constructor(){this.activeUser=null,this.unreadMessages=[]}selectUser(e){const s=new CustomEvent("user-change",{detail:{user:e}});window.dispatchEvent(s)}updateStatusUser(e){const s=new CustomEvent("user-change-status",{detail:{user:e}});window.dispatchEvent(s)}showNewMessage(e){const s=new CustomEvent("new-message",{detail:{id:e.payload.message.id,from:e.payload.message.from,to:e.payload.message.to,text:e.payload.message.text,datetime:e.payload.message.datetime,status:{isDelivered:e.payload.message.status.isDelivered,isReaded:e.payload.message.status.isReaded,isEdited:e.payload.message.status.isEdited}}});this.unreadMessages.push({login:e.payload.message.from,id:e.payload.message.id}),window.dispatchEvent(s)}showUnreadMessages(e,s){if(this.activeUser){const t=e.payload.messages.filter((e=>{var s;return e.to===(null===(s=this.activeUser)||void 0===s?void 0:s.login)})).filter((e=>!e.status.isReaded)),i=t.length;if(i>0){const e=new CustomEvent("unread-messages",{detail:{from:s,count:i}});window.dispatchEvent(e)}t.forEach((e=>{this.unreadMessages.push({login:e.to,id:e.id})}))}}showDialogHistory(e,s){if(this.activeUser){const t=e.payload.messages.filter((e=>{var s,t;return e.to===(null===(s=this.activeUser)||void 0===s?void 0:s.login)||e.from===(null===(t=this.activeUser)||void 0===t?void 0:t.login)}));if(t.length){const e=new CustomEvent("history-dialog",{detail:{user:s,messages:{messages:t}}});window.dispatchEvent(e)}}}allMessagesRead(e){const s=new CustomEvent("unread-messages",{detail:{from:e,count:0}});window.dispatchEvent(s),this.removeUnreadMessagesFromUser(e)}removeUnreadMessagesFromUser(e){const s=this.unreadMessages.filter((s=>s.login!==e));this.unreadMessages=[...s]}setCurrentUser(e,s){this.activeUser={login:e,password:s,isLogined:!1}}setActiveUser(){this.activeUser&&(this.activeUser.isLogined=!0)}getActiveUser(){return this.activeUser}logout(){if(this.activeUser){c.sendRequestForUserLogout(this.activeUser),this.activeUser=null;const e=new CustomEvent("logout",{detail:{}});window.dispatchEvent(e)}}deleteMessage(e){if(!e.payload.message.status.isDeleted)return;const s=new CustomEvent("delete-message",{detail:{id:e.payload.message.id}});window.dispatchEvent(s),this.checkUnreadMessage(e.payload.message.id)}updateUnreadMessages(e,s){const t=new CustomEvent("unread-messages",{detail:{from:e,count:s}});window.dispatchEvent(t)}checkUnreadMessage(e){const s=this.unreadMessages.find((s=>s.id===e));if(s){const t=this.unreadMessages.filter((t=>t.login===s.login&&t.id!==e)).length;this.updateUnreadMessages(s.login,t);const i=this.unreadMessages.filter((s=>s.id!==e));this.unreadMessages=[...i]}}editMessage(e,s){const t=new CustomEvent("edit-message",{detail:{id:e,text:s}});window.dispatchEvent(t)}editMessageInChat(e){if(!e.payload.message.status.isEdited)return;const s=new CustomEvent("edited-message",{detail:{id:e.payload.message.id,text:e.payload.message.text}});window.dispatchEvent(s)}changeStatusToDelivery(e){if(!e.payload.message.status.isDelivered)return;const s=new CustomEvent("change-status",{detail:{id:e.payload.message.id,status:{isDelivered:!0,isReaded:!1,isEdited:!1}}});window.dispatchEvent(s)}changeStatusToRead(e){if(!e.payload.message.status.isReaded)return;const s=new CustomEvent("change-status",{detail:{id:e.payload.message.id,status:{isDelivered:!0,isReaded:!0,isEdited:!1}}});window.dispatchEvent(s)}};d.start()})();